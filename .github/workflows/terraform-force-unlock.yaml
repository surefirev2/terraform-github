# Synced from template â€” do not edit. Changes will be overwritten on the next sync.
# Manual workflow to remove the current Terraform state lock.
# Run from Actions tab when a lock is stuck (e.g. after a cancelled run).
name: Terraform force-unlock

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  force-unlock:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure scripts are executable
        run: chmod +x .github/scripts/*.sh

      - name: Set up Terraform (for lockfile check)
        uses: hashicorp/setup-terraform@v4
        with:
          terraform_version: "1.5.0"
      - name: Install pre-commit
        run: pip install pre-commit
      - name: Check Terraform lock file (pinned providers)
        run: pre-commit run terraform-lockfile --all-files

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v2

      - name: Prepare .env for Terraform
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          TF_GITHUB_ORG: ${{ github.repository_owner }}
          TF_GITHUB_REPO: ${{ github.event.repository.name }}
        run: .github/scripts/terraform-load-env.sh

      - name: Terraform setup
        uses: ./.github/actions/terraform-setup

      - name: Run plan to detect lock (may fail)
        id: plan
        continue-on-error: true
        run: make plan 2>&1 | tee plan-output.txt

      - name: Parse lock ID
        id: parse
        run: |
          LOCK_ID="$(.github/scripts/terraform-lock-id.sh plan-output.txt)"
          echo "lock_id=$LOCK_ID" >> "$GITHUB_OUTPUT"
          if [ -n "$LOCK_ID" ]; then
            echo "Lock ID: $LOCK_ID"
          else
            echo "No lock ID found in plan output."
          fi

      - name: Force-unlock state
        if: steps.parse.outputs.lock_id != ''
        run: make force-unlock LOCK_ID="${{ steps.parse.outputs.lock_id }}"

      - name: Summary
        run: |
          if [ -n "${{ steps.parse.outputs.lock_id }}" ]; then
            echo "## Unlock result" >> "$GITHUB_STEP_SUMMARY"
            echo "Force-unlocked state with ID: \`${{ steps.parse.outputs.lock_id }}\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## No lock found" >> "$GITHUB_STEP_SUMMARY"
            echo "Plan output did not contain a lock ID. State may already be unlocked or the failure was for another reason." >> "$GITHUB_STEP_SUMMARY"
          fi
